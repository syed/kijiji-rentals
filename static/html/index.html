<html>
<head>
    <link type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link type="text/css" href="/static/style/style.css" rel="stylesheet"/>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript"
            src="http://maps.googleapis.com/maps/api/js"></script>
    <script> <!-- Ajax form submission -->
    // Generate 32 char random uuid
    function gen_uuid() {
        var uuid = "";
        for (var i = 0; i < 32; i++) {
            uuid += Math.floor(Math.random() * 16).toString(16);
        }
        return uuid;
    }
    $(function () {
        var form = $("#searchform");
        form.submit(function (e) {
            //prevent double submit
            $("#submitbutton").attr('disabled', true);

            var query_data = form.serializeArray();
            console.log(query_data);

            $.getJSON(form.attr('action'), //url
                query_data,//post data
                function (responseText, responseStatus) {
                    console.log(responseText);

                    $("#submitbutton").attr('disabled', false);
                    addMarkers(responseText);
                }
            );
            // prevent actual submit from happening
            e.preventDefault();
        });
    });

    $(function () {
        $("#datepicker").datepicker({minDate: -20, maxDate: "+1M +10D"});
    });
    </script> <!-- End Ajax form submission -->

    <script type="text/javascript"> <!-- Google maps API -->
    // globals
    var curr_info_window = false;
    var map = false;
    var markersArray = [];
    function initialize_map() {
        var mapOptions = {
            center: new google.maps.LatLng(45.5081, -73.5550), //hardcoded to montreal's centre
            zoom: 12,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;


        map = new google.maps.Map(document.getElementById("map_canvas"),
            mapOptions);
    }

    function addMarkers(results) {
        deleteOverlays(); //remove the old ones
        for (i=0; i<results.length; i++){
            res = results[i];
            if (res.map_location == null) {
                continue;
            }
            var mylat = new google.maps.LatLng(res.map_location.lat, res.map_location.lng);

            var marker = new google.maps.Marker({
                position: mylat,
                title: res.price.toString()
            });

            marker.setMap(map);
            markersArray.push(marker);

            // Content string
            var info_data = '<b>' + res.title + '</b><br>' +
                'rent: $' + res.price + '<br>' +
                'date: ' + res.date_listed + '<br>' +
                'ad_link: <a href="' + res.url + '" target=_blank >Here </a>';
            listenMarker(map, marker, info_data);
        }
    }

    function listenMarker(map, marker, info_data) {
        var info_window = new google.maps.InfoWindow({content: info_data});
        //click on marker will open popup
        google.maps.event.addListener(marker, 'click', function () {
            if (curr_info_window) {
                curr_info_window.close();
            }
            info_window.open(map, marker);
            //update curr_info_window
            curr_info_window = info_window;
        });
    }
    function deleteOverlays() {
        if (markersArray) {
            for (i in markersArray) {
                markersArray[i].setMap(null);
            }
            markersArray.length = 0;
        }
    }
    </script><!-- End Google maps API -->

</head>


<body onload="initialize_map()">
<div id="main">
    <div id="header">
        <div id="logo">
            <div id="logo_text"><h1> RentalSearch </h1></div>
        </div>
    </div>
</div>

<form action="/query" method="post" id="searchform" style="padding-bottom: 8px">
    <p>
    <div class="form_settings" style="float:left">
        <label for="query">Enter Keyword to search for rentals </label>
        <input type="text" name="query" class="contact" id="query"/>

        <label for="datepicker">Date:</label>
        <input type="text" id="datepicker" name="date">

        <input id="submitbutton" type="submit" value="search" class="submit"/>
    </div>
    </p>
</form>
<div id="map_canvas" style="width:100%; height:100%"></div>

</body>
</html>